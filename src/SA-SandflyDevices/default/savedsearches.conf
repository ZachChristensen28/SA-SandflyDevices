# DO NOT EDIT THIS FILE!
# Please make all changes to files in ../local.
# To make changes, copy the section/stanza you want to change from ./default
# into ../local and edit there.

[SA-SandflyDevices Lookup - Gen]
disabled = false
cron_schedule = 7 * * * *
description = populates kvstore lookup: sa_sandfly_devices
dispatch.earliest_time = -61m@m
dispatch.latest_time = -1m@m
enableSched = 1
schedule_window = auto
search = `sa_sandfly_index` sourcetype="sandfly:devices" event_type="device_summary" sandfly_device.active="true"\
| rename sandfly_device.last_seen_ip_addr as ip, sandfly_device.os_info_node as dns \
| dedup sandfly_device.host_id \
| eval\
    last_seen=strptime('sandfly_device.date_last_seen',"%FT%T%Z"),\
    uptime=if(relative_time(now(), "@d")>relative_time(last_seen, "@d"), "unknown", 'sandfly_device.os_info_uptime_days'),\
    is_online=if(uptime=="unknown", "false", "true"),\
    auth_status=if(uptime=="unknown", "unknown",'sandfly_device.authentication_status'),\
    alert_count=if(uptime=="unknown", "unknown", 'sandfly_device.results_alert'),\
    category=mvjoin(mvsort(lower(mvappend(\
    "gen: sa-sandfly",\
    "active: ".'sandfly_device.active',\
    "alert_count: ".alert_count,\
    "auth_status: ".auth_status,\
    "device_tag: ".mvjoin('sandfly_device.tags{}', ","),\
    "first_seen: ".strftime(strptime('sandfly_device.date_first_seen',"%FT%T%Z"), "%x %T %Z"),\
    "is_online: ".is_online,\
    "last_seen: ".strftime(last_seen, "%x %T %Z"),\
    "first_ip: ".'sandfly_device.first_seen_ip_addr',\
    "os: ".'sandfly_device.os_info_os_release_name',\
    "os_version: ".'sandfly_device.os_info_os_release_version',\
    "kernel: ".'sandfly_device.os_info_release',\
    "uptime_days: ".uptime,\
    "os_bugs: ".mvjoin('sandfly_device.os_hardware_cpu_bugs{}', ","),\
    "splunk_last_updated: ".strftime(now(), "%x %T %Z")\
    ))), "|"),\
    nt_host=mvindex(split(dns, "."),0),\
    priority=case(match(category, "domain_controller"), "critical", match(category, "server|ubuntu|rhel|linux"), "high", true(), "medium"),\
    is_expected=if(priority=="critical", "true", "false"),\
    _last_seen=now(),\
    _key=md5('sandfly_device.host_id') \
| table _key,_last_seen,ip,nt_host,dns,category\
| outputlookup key_field=_key sa_sandfly_devices\
| stats count

[SA-SandflyDevices Lookup - Cleanup]
disabled = false
cron_schedule = 17 * * * *
description = removes old entries from kvstore lookup: sa_sandfly_devices
dispatch.earliest_time = -1s
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = | inputlookup sa_sandfly_devices \
| where _last_seen>relative_time(now(), `sa_sandfly_retention`) \
| outputlookup sa_sandfly_devices \
| stats count
